<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Bingo Overlay</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: black;
      height: 100vh; width: 100vw;
      display: flex; justify-content: center; align-items: center;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #bingo-container {
      position: relative;
      max-width: 100vw;
      max-height: 100vh;
      width: 1920px;
      height: 1920px;
      background: url('bingo.png') no-repeat center/contain;
      user-select: none;
    }
    .bingo-cell {
      position: absolute;
      color: transparent;
      font-weight: bold;
      display: flex; justify-content: center; align-items: center;
      border-radius: 6px;
      background-color: rgba(0,0,0,0.4);
      user-select: none;
      pointer-events: none;
      transition: all 0.2s ease;
      background-image: none;
    }
  </style>
</head>
<body>
  <div id="bingo-container"></div>

  <script>
    const container = document.getElementById('bingo-container');

    const offsetLeft = 80;
    const offsetTop = 545;
    const offsetRight = 71;
    const offsetBottom = 132;

    const totalWidth = 1920;
    const totalHeight = 1920;

    const markedCells = new Set();

    function createCells() {
      container.innerHTML = '';

      const containerWidth = container.clientWidth;
      const containerHeight = container.clientHeight;
      const imageRatio = totalWidth / totalHeight;
      const containerRatio = containerWidth / containerHeight;

      let displayedWidth, displayedHeight, paddingX = 0, paddingY = 0;

      if (containerRatio > imageRatio) {
        displayedHeight = containerHeight;
        displayedWidth = displayedHeight * imageRatio;
        paddingX = (containerWidth - displayedWidth) / 2;
      } else {
        displayedWidth = containerWidth;
        displayedHeight = displayedWidth / imageRatio;
        paddingY = (containerHeight - displayedHeight) / 2;
      }

      const scaleX = displayedWidth / totalWidth;
      const scaleY = displayedHeight / totalHeight;

      const usableWidth = totalWidth - offsetLeft - offsetRight;
      const usableHeight = totalHeight - offsetTop - offsetBottom;

      const cellWidth = usableWidth / 5;
      const cellHeight = usableHeight / 5;

      for (let row = 0; row < 5; row++) {
        for (let col = 0; col < 5; col++) {
          const cell = document.createElement('div');
          cell.classList.add('bingo-cell');
          cell.textContent = row * 5 + col + 1;

          const left = offsetLeft + col * cellWidth;
          const top = offsetTop + row * cellHeight;

          cell.style.left = (left * scaleX + paddingX) + 'px';
          cell.style.top = (top * scaleY + paddingY) + 'px';
          cell.style.width = (cellWidth * scaleX) + 'px';
          cell.style.height = (cellHeight * scaleY) + 'px';

          container.appendChild(cell);
        }
      }
    }

    function markCell(cellId) {
      const cells = container.getElementsByClassName('bingo-cell');
      const cellNumber = parseInt(cellId.replace('bingoCell', ''), 10);
      if (!cellNumber || cellNumber < 1 || cellNumber > cells.length) return;
      if (markedCells.has(cellNumber)) return;

      const cell = cells[cellNumber - 1];
      if (!cell) return;

      cell.style.backgroundImage = "url('x.png')";
      cell.style.backgroundSize = "contain";
      cell.style.backgroundRepeat = "no-repeat";
      cell.style.backgroundPosition = "center";

      markedCells.add(cellNumber);
    }

    function resetMarks() {
      const cells = container.getElementsByClassName('bingo-cell');
      markedCells.clear();
      for (let cell of cells) {
        cell.style.backgroundImage = 'none';
      }
    }

    window.addEventListener('message', (event) => {
      if (event.origin !== 'https://tikfinity.zerody.one') return;

      const data = event.data;

      if (data.type === 'gift' && typeof data.feldId === 'string') {
        markCell(data.feldId);
      }

      if (data.type === 'resetBingo') {
        resetMarks();
        console.log('Bingo Overlay: Markierungen automatisch zurückgesetzt.');
      }
    });

    window.addEventListener('load', createCells);
    window.addEventListener('resize', createCells);
  </script>

  <script>
    // ✨ WebSocket-Verbindung
    const WEBSOCKET_URL = "wss://4ff0-109-193-1-96.ngrok-free.app"; // HIER NGROK URL EINTRAGEN
    const socket = new WebSocket(WEBSOCKET_URL);

    socket.addEventListener("message", (event) => {
      try {
        const data = JSON.parse(event.data);
        if (data.type === 'gift' && data.feldId) {
          window.postMessage({ type: "gift", feldId: data.feldId }, "*");
        }
        if (data.type === 'resetBingo') {
          window.postMessage({ type: "resetBingo" }, "*");
        }
      } catch (e) {
        console.error("Fehler beim Parsen der Nachricht:", e);
      }
    });

    socket.addEventListener("open", () => {
      console.log("WebSocket verbunden");
    });

    socket.addEventListener("close", () => {
      console.warn("WebSocket getrennt");
    });

    socket.addEventListener("error", (e) => {
      console.error("WebSocket-Fehler:", e);
    });
  </script>
</body>
</html>
